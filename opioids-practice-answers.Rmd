---
title: "The Opioids Problem Set"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This problem set was designed with the goal of teaching some basic functions, syntax, and workflow in R. The dataset in question is a profile of opioids generated by the DEA and provided by the Washington Post. This exercise will use the tidyverse, tigris, viridis, tidycensus, gganimate, and sf packages. 

```{r}
#this is a code chunk, you can create one yourself with "Insert" -> "R" or by just typing "```{r}" and pressing enter. You can comment with the hash key. 

library(tidyverse)#here's how to load a package. make sure you install it in the console with install_packages(PACKAGE_NAME) first. 
```

1. Import the opioids dataset and the counties shapefile.  

```{r}
#pro-tip: press tab for autocomplete of file names
counties <- readRDS("countyshapes.RDS")
opioids <- read_csv("Opioid Pills Sold by Manufacturer.csv", col_types = "dccdc")
```

2. What are the names of the county-year-labeler observations that have the ten highest numbers of opioid pills sold? 

```{r}
opioids %>% arrange(total_pills) %>% head(10)

```
3. What are the states with the ten highest total number of opioid pills sold over the years 2006-2012? Which manufacturers sold the ten highest number of opioid pills over the years 2006-2012? 

```{r}
#options(scipen=999) disables scientific notation
opioids %>% group_by(state) %>% summarize(total_pills = sum(total_pills, na.rm=TRUE)) %>% arrange(-total_pills)

opioids %>% group_by(Combined_Labeler_Name) %>% 
  summarize(total_pills = sum(total_pills, na.rm=TRUE)) %>% 
  arrange(-total_pills)
```
4. Make a choropleth map representing total number of opioid pills sold over 2006-2012 at the county level. Add the viridis color scale and remove the borders of the counties to make it look nicer. 

```{r}
simple_map <- opioids %>% group_by(fips) %>% 
  summarize(total_pills=sum(total_pills)) %>% 
  full_join(counties, by = c("fips" = "GEOID")) %>% 
  st_as_sf() %>% st_simplify()

ggplot(simple_map, aes(fill = sqrt(total_pills))) + geom_sf(color=NA) + scale_color_viridis()

```

5. Notably, this map is disproportionately skewed towards high-population counties (AKA major cities). This would still be useful, but a more common map would be per-capita information on opioid pills. Let’s assume county populations are constant from 2006-2012, the years available with this dataset, an assumption that I’m fairly comfortable with making. Download total county populations from the 2007-2012 5-year ACS using the tidycensus package. 
6. Merge this into the opioids dataset and create a new column representing opioid pills sold per capita. 
7. Make sure you’ve aggregated to total pills per county over 2006-2012 and make a new map, again with the viridis scale and county borders removed. Take a visual check with the map you made in #5 to assure yourself that the per-capita distinction is indeed an important one. 
8. Let’s take it up a notch! Time is an interesting and relevant variable here, but one that often looks weird with maps. One way is to use a facet_wrap to create a different map for each year. Recreate the map from step 8, but facet by year using the facet_wrap() command. 
9. Another, more fun but slightly harder way to represent time with a map is through an animation. Create an animation (frame # and rate to your preference) that represents the total number of opioid pills sold per year in each county on a map. 
